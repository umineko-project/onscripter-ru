pkgname=zlib
pkgver=1.2.12
pkgrel=1
sources=(
    "https://github.com/m3t4f1v3/onscripter-deps-updated/raw/master/archives/${pkgname}-${pkgver}.tar.gz" #https://sourceforge.net/projects/libpng/files/latest/download
    'zlib-windows-configure.patch'
)
CFLAGS="$CFLAGS ${cflags[@]} -fPIC"
hashes=(
    '91844808532e5ce316b3c010929493c0244f3d37593afd6de04f71821d5136d9'
    'dd46ca3e05fece429a4f32953a7a444439356648a61ee9ac4ac6c1afc22f7b17'
)
build() {
    pushd "$pkgname-${pkgver}" &>/dev/null
    if [ "$(getHost)" == "win32" ]; then
        apply_patch "${sources[1]}"
    fi
    
    msg "Configuring %s" "$pkgname"
    
    export CFLAGS="$CFLAGS ${cflags[@]} $CFLAGS_EXTRA"
    export CPPFLAGS="$CPPFLAGS ${cppflags[@]} $CPPFLAGS_EXTRA"
    export LDFLAGS="$LDFLAGS ${ldflags[@]} $LDFLAGS_EXTRA"
    
    case $(getTarget) in
        darwin*|droid)
            export CC="$(getCC)";;
    esac
    
    local ret=0
    local logfile="$logdir/$pkgname.configure.log"
    
    case $(getTarget) in
        darwin*)
            ./configure --prefix="$outdir" --static --archs="$(getArch)" &>"$logfile" || ret=$?
        ;;
        *)
            ./configure --prefix="$outdir" --static &>"$logfile" || ret=$?
        ;;
    esac
        
    if (( $ret )); then
        tail -n 20 "$logfile"
        error "Configuring %s failed" "$pkgname"
        error "The full log is: %s" "$logfile"
        exit 1
    fi
    
    msg "Compiling %s" "$pkgname"
    
    local ret=0
    local logfile="$logdir/$pkgname.compile.log"
    
    make $MAKEOPTS &>"$logfile" || ret=$?
    
    if (( $ret )); then
        tail -n 20 "$logfile"
        error "Compiling %s failed" "$pkgname"
        error "The full log is: %s" "$logfile"
        exit 1
    fi
    
    msg "Installing %s" "$pkgname"
    
    local ret=0
    local logfile="$logdir/$pkgname.install.log"
    
    make $MAKEOPTS install &>"$logfile" || ret=$?
    
    if (( $ret )); then
        tail -n 20 "$logfile"
        error "Installing %s failed" "$pkgname"
        error "The full log is: %s" "$logfile"
        exit 1
    fi
    
    msg "Finishing %s" "$pkgname"
    postbuild    
}

# vim: set syntax=sh:
